import{E as m,n as T,l as $,a as z,s as q,k as A,j as P,t as M,o as O,r as G,q as J,p as W,u as X}from"../element-plus/element-plus.DXxe7Acq.js";import{b as B,u as H}from"../vue-router/vue-router.CTtvUmZ9.js";import{u as K,t as Q}from"../@element-plus/@element-plus.vzwj9fNK.js";import{_ as Y,u as Z,a as ee,t as te}from"../../assets/index-DIF_1HvL.js";import{a as g}from"../axios/axios.Bo0ATomq.js";import{r as D,J as j,ab as ae,o as f,S as U,R as r,a as y,O as o,V as h,c as R,b as oe,x as le,I as re,u as V,X as ne,W as se}from"../@vue/@vue.Cyfx47te.js";import"../lodash-es/lodash-es.BM2zjOfE.js";import"../async-validator/async-validator.DKvM95Vc.js";import"../@vueuse/@vueuse.CI58GgG-.js";import"../@ctrl/@ctrl.r5W6hzzQ.js";import"../@popperjs/@popperjs.D9SI2xQl.js";import"../normalize-wheel-es/normalize-wheel-es.B6fDCfyv.js";const ce=["src"],ie={class:"dialog-footer"},ue={__name:"DialogAddCategory",props:{type:String,reload:Function},setup(L,{expose:_}){const i=L,v=D(null),t=B(),e=j({uploadImgServer:Z,token:ee("token")||"",visible:!1,categoryLevel:1,parentId:0,ruleForm:{name:"",rank:"",url:""},rules:{name:[{required:"true",message:"名称不能为空",trigger:["change"]}],rank:[{required:"true",message:"编号不能为空",trigger:["change"]}]},id:""}),u=s=>{g.get(`/categories/${s}`).then(l=>{e.ruleForm={name:l.categoryName,rank:l.categoryRank,url:l.categoryUrl},e.parentId=l.parentId,e.categoryLevel=l.categoryLevel})},x=s=>{const l=s.name.split(".")[1]||"";if(!["jpg","jpeg","png"].includes(l))return m.error("请上传 jpg、jpeg、png 格式的图片"),!1},C=s=>{e.ruleForm.url=s.data||""},F=s=>{if(e.visible=!0,s)e.id=s,u(s);else{const{level:l=1,parent_id:a=0}=t.query;e.ruleForm={name:"",rank:"",url:""},e.parentId=a,e.categoryLevel=l}},I=()=>{e.visible=!1},w=()=>{v.value.validate(s=>{s&&(i.type=="add"?g.post("/categories",{categoryLevel:e.categoryLevel,parentId:e.parentId,categoryName:e.ruleForm.name,categoryRank:e.ruleForm.rank,categoryUrl:e.ruleForm.url}).then(()=>{m.success("添加成功"),e.visible=!1,i.reload&&i.reload()}):g.put("/categories",{categoryId:e.id,categoryLevel:e.categoryLevel,parentId:e.categoryLevel,categoryName:e.ruleForm.name,categoryRank:e.ruleForm.rank,categoryUrl:e.ruleForm.url}).then(()=>{m.success("修改成功"),e.visible=!1,i.reload&&i.reload()}))})};return _({open:F,close:I}),(s,l)=>{const a=T,c=$,d=ae("Plus"),b=z,p=q,E=A,k=P,S=M;return f(),U(S,{title:e.type=="add"?"添加分类":"修改分类",modelValue:e.visible,"onUpdate:modelValue":l[3]||(l[3]=n=>e.visible=n),width:"400px"},{footer:r(()=>[y("span",ie,[o(k,{onClick:l[2]||(l[2]=n=>e.visible=!1)},{default:r(()=>[h("取 消")]),_:1}),o(k,{type:"primary",onClick:w},{default:r(()=>[h("确 定")]),_:1})])]),default:r(()=>[o(E,{model:e.ruleForm,rules:e.rules,ref_key:"formRef",ref:v,"label-width":"100px",class:"good-form"},{default:r(()=>[o(c,{label:"商品名称",prop:"name"},{default:r(()=>[o(a,{type:"text",modelValue:e.ruleForm.name,"onUpdate:modelValue":l[0]||(l[0]=n=>e.ruleForm.name=n)},null,8,["modelValue"])]),_:1}),o(c,{label:"排序值",prop:"rank"},{default:r(()=>[o(a,{type:"number",modelValue:e.ruleForm.rank,"onUpdate:modelValue":l[1]||(l[1]=n=>e.ruleForm.rank=n)},null,8,["modelValue"])]),_:1}),o(c,{label:"图片",prop:"url"},{default:r(()=>[o(p,{class:"avatar-uploader",action:e.uploadImgServer,accept:"jpg,jpeg,png",headers:{token:e.token},"show-file-list":!1,"before-upload":x,"on-success":C},{default:r(()=>[e.ruleForm.url?(f(),R("img",{key:0,style:{width:"200px",height:"100px","object-fit":"contain",border:"1px solid #e9e9e9"},src:e.ruleForm.url,class:"avatar"},null,8,ce)):(f(),U(b,{key:1,class:"avatar-uploader-icon"},{default:r(()=>[o(d)]),_:1}))]),_:1},8,["action","headers"])]),_:1})]),_:1},8,["model","rules"])]),_:1},8,["title","modelValue"])}}},de=Y(ue,[["__scopeId","data-v-b1a5a7da"]]),pe={class:"header"},me=["src"],ge=["onClick"],_e=["onClick"],fe=y("a",{style:{cursor:"pointer"}},"删除",-1),Ve={__name:"Category",setup(L){const _=D(null),i=H(),v=B(),t=j({loading:!1,tableData:[],multipleSelection:[],total:0,currentPage:1,pageSize:10,type:"add",level:1,parent_id:0});oe(()=>{u()}),le(()=>{console.log(t.pageSize)});const e=i.afterEach(a=>{["category","level2","level3"].includes(a.name)&&u()});re(()=>{e()});const u=()=>{const{level:a=1,parent_id:c=0}=v.query;t.loading=!0,g.get("/categories",{params:{pageNumber:t.currentPage,pageSize:t.pageSize,categoryLevel:a,parentId:c}}).then(d=>{t.tableData=d.list,t.total=d.totalCount,t.currentPage=d.currPage,t.loading=!1,t.level=a,t.parentId=c})},x=a=>{t.currentPage=a,u()},C=a=>{const c=a.categoryLevel+1;if(c==4){m.error("没有下一级");return}i.push({name:`level${c}`,query:{level:c,parent_id:a.categoryId}})},F=()=>{t.type="add",_.value.open()},I=a=>{t.type="edit",_.value.open(a)},w=a=>{t.multipleSelection=a},s=()=>{if(!t.multipleSelection.length){m.error("请选择项");return}g.delete("/categories",{data:{ids:t.multipleSelection.map(a=>a.categoryId)}}).then(()=>{m.success("删除成功"),u()})},l=a=>{g.delete("/categories",{data:{ids:[a]}}).then(()=>{m.success("删除成功"),u()})};return(a,c)=>{const d=P,b=G,p=J,E=W,k=X,S=O;return f(),U(S,{class:"category-container"},{header:r(()=>[y("div",pe,[o(d,{type:"primary",icon:V(K),onClick:F},{default:r(()=>[h("增加")]),_:1},8,["icon"]),o(b,{title:"确定删除吗？",confirmButtonText:"确定",cancelButtonText:"取消",onConfirm:s},{reference:r(()=>[o(d,{type:"danger",icon:V(Q)},{default:r(()=>[h("批量删除")]),_:1},8,["icon"])]),_:1})])]),default:r(()=>[o(E,{load:t.loading,ref:"multipleTable",data:t.tableData,"tooltip-effect":"dark",style:{width:"100%"},onSelectionChange:w},{default:r(()=>[o(p,{type:"selection",width:"55"}),o(p,{prop:"categoryName",label:"分类名称"}),o(p,{label:"三级分类图",width:"200"},{default:r(n=>[n.row.categoryUrl?(f(),R("img",{key:0,style:{width:"150px",height:"150px","object-fit":"contain"},src:n.row.categoryUrl,alt:"分类图"},null,8,me)):ne("",!0)]),_:1}),o(p,{prop:"categoryRank",label:"排序值",width:"120"}),o(p,{prop:"createdAt",label:"注册时间",width:"200"},{default:r(n=>[h(se(V(te)(n.row.createdAt)),1)]),_:1}),o(p,{label:"操作",width:"220"},{default:r(n=>[y("a",{style:{cursor:"pointer","margin-right":"10px"},onClick:N=>I(n.row.categoryId)},"修改",8,ge),y("a",{style:{cursor:"pointer","margin-right":"10px"},onClick:N=>C(n.row)},"下级分类",8,_e),o(b,{title:"确定删除吗？",confirmButtonText:"确定",cancelButtonText:"取消",onConfirm:N=>l(n.row.categoryId)},{reference:r(()=>[fe]),_:2},1032,["onConfirm"])]),_:1})]),_:1},8,["load","data"]),o(k,{background:"",layout:"prev, pager, next",total:t.total,"page-size":t.pageSize,"current-page":t.currentPage,onCurrentChange:x},null,8,["total","page-size","current-page"]),o(de,{ref_key:"addCate",ref:_,reload:u,type:t.type},null,8,["type"])]),_:1})}}};export{Ve as default};
